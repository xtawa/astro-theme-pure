name: åŒæ­¥ï¼ˆé˜¿é‡Œäº‘ï¼‰OSSåˆ°Obsidianä»“åº“

on:
  # æ¯ 3 å°æ—¶è‡ªåŠ¨åŒæ­¥ä¸€æ¬¡ï¼ˆUTC æ—¶é—´ï¼‰
  schedule:
    - cron: '0 */5 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  sync-from-oss: # Job åç§°æ›´æ”¹ï¼Œä»¥åæ˜  OSS æœåŠ¡
    runs-on: ubuntu-latest
    # ğŸ”´ ã€æ–°å¢æƒé™å—ã€‘æˆäºˆå¯¹ä»“åº“å†…å®¹çš„å†™å…¥æƒé™
    permissions:
      contents: write 
    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»£ç 
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 

      # 2ï¸âƒ£ å®‰è£…å¹¶é…ç½® ossutilï¼ˆé˜¿é‡Œäº‘ OSS å®˜æ–¹ CLIï¼‰
      # !! æ­¤æ­¥éª¤å–ä»£äº† git9527/setup-coscli@v2 !!
      - name: å®‰è£…å¹¶é…ç½® ossutil
        run: |
          # å®‰è£… ossutil
          sudo wget -q http://gosspublic.alicdn.com/ossutil/1.7.15/ossutil64 -O /usr/local/bin/ossutil
          sudo chmod 755 /usr/local/bin/ossutil
          
          # æ„é€ æ­£ç¡®çš„ Aliyun OSS Endpoint: oss-${REGION}.aliyuncs.com
          # å‡è®¾ COS_REGION å˜é‡å­˜å‚¨çš„æ˜¯ Aliyun åœ°åŒºçš„ ID (å¦‚ cn-shanghai)
          ENDPOINT="oss-${{ secrets.COS_REGION }}.aliyuncs.com"

          # åˆ›å»ºé…ç½®æ–‡ä»¶ ~/.ossutilconfigï¼Œossutil ä¼šä½¿ç”¨è¿™ä¸ªæ–‡ä»¶è¿æ¥
          echo "[Credentials]" > ~/.ossutilconfig
          echo "language = EN" >> ~/.ossutilconfig
          echo "endpoint = $ENDPOINT" >> ~/.ossutilconfig
          echo "accessKeyID = ${{ secrets.COS_SECRET_ID }}" >> ~/.ossutilconfig
          echo "accessKeySecret = ${{ secrets.COS_SECRET_KEY }}" >> ~/.ossutilconfig
          
          echo "ossutil é…ç½®å®Œæˆï¼ŒEndpoint ä½¿ç”¨ï¼š$ENDPOINT âœ…"
          
      # 3ï¸âƒ£ ä» OSS ä¸‹è½½åˆ°æœ¬åœ° content/ï¼ˆä¿æŒå®Œå…¨ä¸€è‡´ï¼Œä½†ä¿ç•™ .gitkeepï¼‰
      - name: æ‹‰å– OSS æ–‡ä»¶åˆ° content/
        run: |
          # è‡ªå®šä¹‰çš„é‡è¦æ–‡ä»¶ï¼Œéœ€è¦å¤‡ä»½å’Œæ¢å¤
          mkdir -p /tmp/content_backup
          if [ -f "content/.gitkeep" ]; then
            cp content/.gitkeep /tmp/content_backup/
          fi

          # æ¸…ç©ºå¹¶é‡æ–°åˆ›å»º content ç›®å½•
          rm -rf content
          mkdir -p content

          # æ¢å¤é‡è¦æ–‡ä»¶
          if [ -f "/tmp/content_backup/.gitkeep" ]; then
            cp /tmp/content_backup/.gitkeep content/
          else
            touch content/.gitkeep
          fi

          # **!!! æ ¸å¿ƒä¿®æ”¹ç‚¹ï¼šä½¿ç”¨ ossutil cp -r æ›¿æ¢ coscli sync !!!**
          # æ‰§è¡ŒåŒæ­¥ï¼Œä½¿ç”¨ ossutil çš„é€’å½’å¤åˆ¶å‘½ä»¤
          ossutil cp -r \
            oss://${{ secrets.COS_BUCKET }}/quartz/content/ \
            ./content/
          
          # ç¡®ä¿ .gitkeep åœ¨åŒæ­¥åä»ç„¶å­˜åœ¨
          if [ ! -f "content/.gitkeep" ]; then
            touch content/.gitkeep
          fi

          echo "OSS åŒæ­¥å®Œæˆ âœ…"

      # 4ï¸âƒ£ è‹¥æœ‰å˜åŠ¨å°±æäº¤ (ä¿æŒä¸å˜)
      - name: Commit & push if changed
        env:
          TZ: Asia/Shanghai
        run: |
          git config user.name  "OSS Sync Bot"
          git config user.email "bot@users.noreply.github.com"

          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "chore: sync notes from OSS $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "å·²æ£€æµ‹åˆ°å˜åŠ¨å¹¶æ¨é€ ğŸš€"
          else
            echo "æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤ âœ”"
          fi
