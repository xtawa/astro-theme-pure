name: åŒæ­¥ï¼ˆé˜¿é‡Œäº‘ï¼‰OSSåˆ°Obsidianä»“åº“

on:
  # æ¯ 5 å°æ—¶è‡ªåŠ¨åŒæ­¥ä¸€æ¬¡ï¼ˆUTC æ—¶é—´ï¼‰
  # æ³¨æ„ï¼šè¿™é‡Œä¿æŒäº†ä½ åŸå§‹è¾“å…¥ä¸­çš„ '0 */5 * * *'ï¼Œä»£è¡¨æ¯ 5 å°æ—¶ï¼Œå¦‚æœä½ æƒ³è¦æ¯ 3 å°æ—¶ï¼Œè¯·æ”¹ä¸º '0 */3 * * *'
  schedule:
    - cron: '0 */12 * * *' 
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  sync-from-oss: # Job åç§°æ›´æ”¹ï¼Œä»¥åæ˜  OSS æœåŠ¡
    runs-on: ubuntu-latest
    # ğŸ”´ ã€æ–°å¢æƒé™å—ã€‘æˆäºˆå¯¹ä»“åº“å†…å®¹çš„å†™å…¥æƒé™
    permissions:
      contents: write 
    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»£ç 
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 

      # 2ï¸âƒ£ å®‰è£…å¹¶é…ç½® ossutilï¼ˆé˜¿é‡Œäº‘ OSS å®˜æ–¹ CLIï¼‰
      - name: å®‰è£…å¹¶é…ç½® ossutil
        run: |
          # å®‰è£… ossutil
          sudo wget -q http://gosspublic.alicdn.com/ossutil/1.7.15/ossutil64 -O /usr/local/bin/ossutil
          sudo chmod 755 /usr/local/bin/ossutil
          
          # æ„é€ æ­£ç¡®çš„ Aliyun OSS Endpoint: oss-${REGION}.aliyuncs.com
          # å‡è®¾ COS_REGION å˜é‡å­˜å‚¨çš„æ˜¯ Aliyun åœ°åŒºçš„ ID (å¦‚ cn-shanghai)
          ENDPOINT="oss-${{ secrets.COS_REGION }}.aliyuncs.com"

          # åˆ›å»ºé…ç½®æ–‡ä»¶ ~/.ossutilconfigï¼Œossutil ä¼šä½¿ç”¨è¿™ä¸ªæ–‡ä»¶è¿æ¥
          echo "[Credentials]" > ~/.ossutilconfig
          echo "language = EN" >> ~/.ossutilconfig
          echo "endpoint = $ENDPOINT" >> ~/.ossutilconfig
          echo "accessKeyID = ${{ secrets.COS_SECRET_ID }}" >> ~/.ossutilconfig
          echo "accessKeySecret = ${{ secrets.COS_SECRET_KEY }}" >> ~/.ossutilconfig
          
          echo "ossutil é…ç½®å®Œæˆï¼ŒEndpoint ä½¿ç”¨ï¼š$ENDPOINT âœ…"
          
      # 3ï¸âƒ£ ä» OSS ä¸‹è½½åˆ°æœ¬åœ° src/content/blog/ï¼ˆä¿æŒå®Œå…¨ä¸€è‡´ï¼Œä½†ä¿ç•™ .gitkeepï¼‰
      - name: æ‹‰å– OSS æ–‡ä»¶åˆ° src/content/blog/
        run: |
          # **å®šä¹‰æœ¬åœ°ç›®æ ‡è·¯å¾„**
          TARGET_DIR="./src/content/blog"
          # **å®šä¹‰ OSS æºè·¯å¾„**
          # ğŸ’¡ ä¿®æ”¹ç‚¹ 1/2: OSS æºè·¯å¾„å·²æ›´æ–°
          OSS_SOURCE_PATH="oss://${{ secrets.COS_BUCKET }}/Output/AstroBlog/content/"

          # è‡ªå®šä¹‰çš„é‡è¦æ–‡ä»¶ï¼Œéœ€è¦å¤‡ä»½å’Œæ¢å¤
          mkdir -p /tmp/content_backup
          
          # ä»…å¤‡ä»½ç›®æ ‡è·¯å¾„ä¸‹çš„ .gitkeepï¼Œå¦‚æœå­˜åœ¨çš„è¯
          if [ -f "$TARGET_DIR/.gitkeep" ]; then
            cp "$TARGET_DIR/.gitkeep" /tmp/content_backup/
          fi

          # æ¸…ç©ºç›®æ ‡ç›®å½•å¹¶é‡æ–°åˆ›å»ºï¼Œæ³¨æ„ï¼šéœ€è¦å…ˆç¡®ä¿ä¸Šå±‚ç›®å½• src/content/ å­˜åœ¨
          # ä½¿ç”¨ -p ç¡®ä¿çˆ¶ç›®å½•ä¹Ÿè¢«åˆ›å»º
          rm -rf "$TARGET_DIR"
          mkdir -p "$TARGET_DIR"

          # æ¢å¤é‡è¦æ–‡ä»¶
          if [ -f "/tmp/content_backup/.gitkeep" ]; then
            cp /tmp/content_backup/.gitkeep "$TARGET_DIR/"
          else
            touch "$TARGET_DIR/.gitkeep" # ç¡®ä¿ç›®å½•ä¸ä¸ºç©º
          fi

          # **!!! æ ¸å¿ƒä¿®æ”¹ç‚¹ï¼šä½¿ç”¨ ossutil cp -r æ›¿æ¢ coscli sync !!!**
          # ğŸ’¡ ä¿®æ”¹ç‚¹ 2/2: ossutil cp å‘½ä»¤çš„æºè·¯å¾„å’Œç›®æ ‡è·¯å¾„å·²æ›´æ–°
          # æ‰§è¡ŒåŒæ­¥ï¼Œå°† OSS ä¸Šçš„ /Output/AstroBlog/content/ ä¸‹è½½åˆ°æœ¬åœ° ./src/content/blog/
          ossutil cp -r \
            "$OSS_SOURCE_PATH" \
            "$TARGET_DIR/"
          
          # ç¡®ä¿ .gitkeep åœ¨åŒæ­¥åä»ç„¶å­˜åœ¨
          if [ ! -f "$TARGET_DIR/.gitkeep" ]; then
            touch "$TARGET_DIR/.gitkeep"
          fi

          echo "OSS åŒæ­¥å®Œæˆ âœ…ï¼Œæ–‡ä»¶å·²å­˜å…¥ $TARGET_DIR"

      # 4ï¸âƒ£ è‹¥æœ‰å˜åŠ¨å°±æäº¤ (ä¿æŒä¸å˜)
      - name: Commit & push if changed
        env:
          TZ: Asia/Shanghai
        run: |
          git config user.name  "OSS Sync Bot"
          git config user.email "bot@users.noreply.github.com"

          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "chore: sync notes from OSS $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "å·²æ£€æµ‹åˆ°å˜åŠ¨å¹¶æ¨é€ ğŸš€"
          else
            echo "æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤ âœ”"
          fi
