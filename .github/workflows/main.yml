name: Sync Docs

on:
  # å…è®¸æ‰‹åŠ¨pushè§¦å‘ï¼ˆæ ¹æ®æ‚¨çš„æ³¨é‡Šï¼Œç›®å‰æ˜¯ç¦ç”¨çš„ï¼‰
#  push:
#    branches:
#      - master
  # å…è®¸å¤–éƒ¨ä»“åº“äº‹ä»¶è§¦å‘
  repository_dispatch:
    types:
      - deploy

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€æŸ¥åˆ†æ”¯
        uses: actions/checkout@master
        # å¦‚æœæ‚¨çš„ elog ç›®æ ‡ä»“åº“åœ¨ä¸åŒçš„åˆ†æ”¯ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ 'ref: master'

      - name: å®‰è£…nodeç¯å¢ƒ
        uses: actions/setup-node@master
        with:
          node-version: "16.x"

      - name: å®‰è£…ä¾èµ–å’ŒElog CLI
        run: |
          export TZ='Asia/Shanghai'
          # å®‰è£… package.json ä¸­çš„ä¾èµ–
          npm install --prod
          # ç¡®ä¿å®‰è£…äº† elog cliï¼Œå¦‚æœå®ƒä¸åœ¨ --prod ä¾èµ–ä¸­
          npm install @elog/cli 

      - name: æ‹‰å–æ–‡æ¡£ (æ³¨å…¥é«˜æƒé™Token)
        env:
          # Notion é…ç½®ï¼ˆä¿æŒä¸å˜ï¼‰
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          
          # æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨æ‚¨æœ‰å†™æƒé™çš„ PIC_TOKEN è¦†ç›– GITHUB_TOKEN
          # elog CLI åœ¨æ‰§è¡Œ GitHub å›¾åºŠä¸Šä¼ æ—¶ä¼šè¯»å– GITHUB_TOKEN
          # GITHUB_TOKEN çš„å˜é‡åæ˜¯ elog å®˜æ–¹æ‰€é¢„æœŸçš„ã€‚
          GITHUB_TOKEN: ${{ secrets.PIC_TOKEN }} 
          
          # Elog Github é…ç½®ï¼ˆå›¾åºŠæˆ–ä»“åº“ä¿¡æ¯ï¼‰
          ELOG_GITHUB_USER: ${{ secrets.ELOG_GITHUB_USER }}
          ELOG_GITHUB_REPO: ${{ secrets.ELOG_GITHUB_REPO }}
          
          # Elog REQUEST_TIMEOUT é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
          REQUEST_TIMEOUT: 900000 
          
        run: |
          # è°ƒè¯•ç¡®è®¤ GITHUB_TOKEN å·²è¢«æ³¨å…¥
          echo "GITHUB_TOKEN is set: $GITHUB_TOKEN"
          # æ‰§è¡ŒåŒæ­¥å‘½ä»¤
          npm run sync

      - name: é…ç½®Gitç”¨æˆ·åé‚®ç®±
        run: |
          git config --global user.name "xtawa"
          git config --global user.email "zaz203@outlook.com"

      - name: æäº¤æ‹‰å–çš„æ–‡æ¡£åˆ°GitHubä»“åº“
        run: |
          echo `date +"%Y-%m-%d %H:%M:%S"` begin > time.txt
          git add .
          # æ³¨æ„ï¼š-a é€‰é¡¹ä¼šæäº¤æ‰€æœ‰å·²è·Ÿè¸ªçš„æ–‡ä»¶ï¼Œå¦‚æœ elog æœ‰æ›´æ”¹ï¼Œéƒ½ä¼šè¢«æäº¤
          git commit -m "Refresh elog.cache.json" -a

      - name: æ¨é€æ–‡æ¡£åˆ°ä»“åº“
        uses: ad-m/github-push-action@master
        with:
          # å…³é”®ï¼šad-m/github-push-action ä¹Ÿéœ€è¦ä¸€ä¸ªæœ‰å†™æƒé™çš„ Token æ¥æ¨é€
          # åŒæ ·ä½¿ç”¨æ‚¨çš„ PIC_TOKEN
# ğŸš¨ å…³é”®ä¿®æ”¹ï¼šæ·»åŠ å¼ºåˆ¶æ¨é€é€‰é¡¹ï¼Œè§£å†³ 'rejected' é”™è¯¯
          force: true
          github_token: ${{ secrets.PIC_TOKEN }}
          # å¦‚æœæ¨é€å¤±è´¥ï¼Œè¯·ç¡®ä¿æ‚¨çš„ git config é‚®ç®±å’Œç”¨æˆ·åä¸ PIC_TOKEN å…³è”çš„è´¦æˆ·åŒ¹é…
